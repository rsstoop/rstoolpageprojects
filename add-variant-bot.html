<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CSV Processor</title>
  <link rel="icon" href="https://cdn.shopify.com/s/files/1/0877/4605/2441/files/WhatsApp_Image_2024-10-15_at_18.39.24_121ada59-56ef-4939-b179-3e038d22f224.jpg?v=1733180929">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f9f9f9; --card:#fff; --muted:#666; --text:#222; --brand:#28a745; --brandDark:#218838; --tab:#e9ecef;
      --radius:10px;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, Arial, sans-serif; color:var(--text);
      max-width: 760px; margin: 24px auto; padding: 12px;
      background: var(--bg);
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 2px 16px rgba(0,0,0,.08);
      padding: 18px;
    }
    h1{
      display:flex; gap:10px; align-items:center; justify-content:center;
      font-size: 1.35rem; margin: 0 0 14px;
    }
    .muted{color:var(--muted); font-size:.9rem}
    label{display:block; margin:12px 0 6px; font-weight:600}
    input[type="text"], input[type="number"], input[type="file"]{
      width:100%; padding:10px 12px; border:1px solid #d8d8d8; border-radius:8px; font-size:0.95rem;
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    button{
      width:100%; padding:12px 14px; border:0; border-radius:10px; cursor:pointer;
      background:var(--brand); color:#fff; font-weight:700; margin-top:8px; font-size:1rem;
    }
    button:hover{background:var(--brandDark)}
    .tabs{display:flex; border-radius:10px; overflow:hidden; margin:10px 0 6px}
    .tab{
      flex:1; text-align:center; padding:10px; font-weight:700; cursor:pointer;
      background:var(--tab); border:1px solid #d8d8d8; border-right:0;
      user-select:none;
    }
    .tab:last-child{border-right:1px solid #d8d8d8}
    .tab.active{background:#fff; color:#000}
    .mode{display:none}
    .mode.active{display:block; animation:fade .15s ease-in}
    @keyframes fade{from{opacity:.4; transform:translateY(2px)} to{opacity:1; transform:none}}
    .help{font-size:.85rem; color:#555}
    .stack{display:grid; gap:8px}
  </style>
</head>
<body>
  <h1>
    <img src="https://cdn.shopify.com/s/files/1/0877/4605/2441/files/WhatsApp_Image_2024-10-15_at_18.39.24_121ada59-56ef-4939-b179-3e038d22f224.jpg?v=1733180929" style="width: 24px;">
    CSV Processor – Neontheway.com
  </h1>

  <div class="card stack">
    <div>
      <label for="csvFile">CSV bestand</label>
      <input type="file" id="csvFile" accept=".csv" />
    </div>

    <div class="row">
      <div>
        <label for="startSize">Minimum size (bijv. “50 cm x 80 cm”):</label>
        <input type="text" id="startSize" placeholder="50 cm x 80 cm">
      </div>
      <div>
        <label for="maxSize">Maximum size (bijv. “200 cm x 320 cm”):</label>
        <input type="text" id="maxSize" placeholder="200 cm x 320 cm">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="variantCount">Hoeveelheid extra varianten (default: 50):</label>
        <input type="number" id="variantCount" placeholder="50" value="50" min="1">
      </div>
      <div class="help" style="align-self:end;">
        Maten worden altijd gelijkmatig verdeeld tussen minimum en maximum.
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Pricing mode">
      <div class="tab active" id="tab-percentage" role="tab" aria-selected="true" aria-controls="mode-percentage" tabindex="0">Percentage (default)</div>
      <div class="tab" id="tab-linear" role="tab" aria-selected="false" aria-controls="mode-linear" tabindex="-1">Linear</div>
    </div>

    <!-- Percentage mode -->
    <div class="mode active" id="mode-percentage" role="tabpanel" aria-labelledby="tab-percentage">
      <div class="row">
        <div>
          <label for="startPricePct">Minimum price</label>
          <input type="number" step="0.01" id="startPricePct" placeholder="99.99">
        </div>
        <div>
          <label for="startComparePct">Minimum Compare At Price</label>
          <input type="number" step="0.01" id="startComparePct" placeholder="199.99">
        </div>
      </div>
      <div class="row3">
        <div>
          <label for="cmStep">Every X cm (default 3):</label>
          <input type="number" id="cmStep" min="0.1" step="0.1" value="3">
        </div>
        <div>
          <label for="pctPerStep">Add X % per step (default 2.5):</label>
          <input type="number" id="pctPerStep" step="0.01" value="2.5">
        </div>
        <div>
          <label for="roundPrices">Price rounding (optional, e.g., 0.99):</label>
          <input type="number" id="roundPrices" step="0.01" placeholder="">
        </div>
      </div>
      <p class="help">
        Compounds by X% for each X cm increase of the <b>longest side</b> compared to the minimum size.  
        Example: 2.5% per 3 cm.
      </p>
    </div>

    <!-- Linear mode -->
    <div class="mode" id="mode-linear" role="tabpanel" aria-labelledby="tab-linear">
      <div class="row">
        <div>
          <label for="startPrice">Minimum price</label>
          <input type="number" step="0.01" id="startPrice" placeholder="99.99">
        </div>
        <div>
          <label for="maxPrice">Maximum price</label>
          <input type="number" step="0.01" id="maxPrice" placeholder="400">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="startComparePrice">Minimum Compare At Price</label>
          <input type="number" step="0.01" id="startComparePrice" placeholder="199.99">
        </div>
        <div>
          <label for="maxComparePrice">Maximum Compare At Price</label>
          <input type="number" step="0.01" id="maxComparePrice" placeholder="800">
        </div>
      </div>
      <p class="help">Lineair van minimum naar maximum prijs.</p>
    </div>

    <button id="runBtn">Voeg varianten toe!</button>
    <p class="muted">De output wordt gedownload als <code>processed_file.csv</code>.</p>
  </div>

  <script>
    // --- Tab logic ---
    const tabPct = document.getElementById('tab-percentage');
    const tabLin = document.getElementById('tab-linear');
    const modePct = document.getElementById('mode-percentage');
    const modeLin = document.getElementById('mode-linear');

    function activateTab(which){
      const isPct = which === 'pct';
      [tabPct, tabLin].forEach(el => el.classList.remove('active'));
      [modePct, modeLin].forEach(el => el.classList.remove('active'));

      if(isPct){
        tabPct.classList.add('active');
        modePct.classList.add('active');
        tabPct.setAttribute('aria-selected','true'); tabPct.setAttribute('tabindex','0');
        tabLin.setAttribute('aria-selected','false'); tabLin.setAttribute('tabindex','-1');
      } else {
        tabLin.classList.add('active');
        modeLin.classList.add('active');
        tabLin.setAttribute('aria-selected','true'); tabLin.setAttribute('tabindex','0');
        tabPct.setAttribute('aria-selected','false'); tabPct.setAttribute('tabindex','-1');
      }
    }
    tabPct.addEventListener('click', ()=>activateTab('pct'));
    tabLin.addEventListener('click', ()=>activateTab('lin'));
    tabPct.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight') activateTab('lin') });
    tabLin.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') activateTab('pct') });

    document.getElementById('runBtn').addEventListener('click', processCSV);

    // --- Helpers ---
    function parseSize(size){
      const m = (size || '').toLowerCase().match(/^\s*(\d+(?:\.\d+)?)\s*cm\s*x\s*(\d+(?:\.\d+)?)\s*cm\s*$/i);
      if(!m) return null;
      return { width: parseFloat(m[1]), height: parseFloat(m[2]) };
    }
    function downloadCSV(csvContent, filename){
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function isPercentageMode(){
      return modePct.classList.contains('active');
    }

    // --- Core ---
    function processCSV(){
      const fileInput = document.getElementById('csvFile');
      if(!fileInput.files.length){ alert('Please select a CSV file first.'); return; }

      const startSize = document.getElementById('startSize').value.trim();
      const maxSize = document.getElementById('maxSize').value.trim();
      const startDim = parseSize(startSize);
      const maxDim = parseSize(maxSize);
      const variantCount = parseInt(document.getElementById('variantCount').value) || 50;

      if(!startDim || !maxDim){ alert('Please provide valid minimum and maximum sizes in "NN cm x NN cm" format.'); return; }
      if(variantCount < 1){ alert('Variant count must be at least 1.'); return; }

      const widthInc  = (maxDim.width  - startDim.width)  / (variantCount - 1 || 1);
      const heightInc = (maxDim.height - startDim.height) / (variantCount - 1 || 1);

      let mode = isPercentageMode() ? 'pct' : 'lin';

      Papa.parse(fileInput.files[0], {
        complete: function(results){
          const rows = results.data;
          if(!rows || rows.length < 2){ alert('CSV does not contain enough rows.'); return; }

          const targetColumns = [0, 18, 20, 21, 22, 25, 26, 53];

          let currentWidth = startDim.width;
          let currentHeight = startDim.height;

          let priceAtIndex = ()=>0;
          let compareAtAtIndex = ()=>0;

          if(mode === 'pct'){
            const startPricePct = parseFloat(document.getElementById('startPricePct').value);
            const startComparePct = parseFloat(document.getElementById('startComparePct').value);
            const cmStep = parseFloat(document.getElementById('cmStep').value) || 3;
            const pctPerStep = parseFloat(document.getElementById('pctPerStep').value) || 2.5;

            if(isNaN(startPricePct) || isNaN(startComparePct)){
              alert('Please enter valid numbers for Minimum price and Minimum Compare At Price.');
              return;
            }
            const startLongest = Math.max(startDim.width, startDim.height);

            priceAtIndex = (i, w, h) => {
              const longest = Math.max(w, h);
              const delta = Math.max(0, longest - startLongest);
              const steps = delta / cmStep;
              const factor = Math.pow(1 + (pctPerStep/100), steps);
              return startPricePct * factor;
            };
            compareAtAtIndex = (i, w, h) => {
              const longest = Math.max(w, h);
              const delta = Math.max(0, longest - startLongest);
              const steps = delta / cmStep;
              const factor = Math.pow(1 + (pctPerStep/100), steps);
              return startComparePct * factor;
            };
          } else {
            const startPrice = parseFloat(document.getElementById('startPrice').value);
            const maxPrice = parseFloat(document.getElementById('maxPrice').value);
            const startComparePrice = parseFloat(document.getElementById('startComparePrice').value);
            const maxComparePrice = parseFloat(document.getElementById('maxComparePrice').value);

            if([startPrice, maxPrice, startComparePrice, maxComparePrice].some(isNaN)){
              alert('Please fill all linear price fields with valid values.');
              return;
            }
            const priceInc = (maxPrice - startPrice) / (variantCount - 1 || 1);
            const compareInc = (maxComparePrice - startComparePrice) / (variantCount - 1 || 1);

            priceAtIndex = (i) => startPrice + priceInc * (i-1);
            compareAtAtIndex = (i) => startComparePrice + compareInc * (i-1);
          }

          for(let i = 1; i < variantCount + 1; i++){
            rows[i] = rows[i] || [];
            const w = currentWidth;
            const h = currentHeight;

            rows[i][9]  = `${Math.round(w)} cm x ${Math.round(h)} cm`;

            const priceVal = priceAtIndex(i, w, h);
            const compareVal = compareAtAtIndex(i, w, h);

            rows[i][23] = (priceVal).toFixed(2);
            rows[i][24] = (compareVal).toFixed(2);

            targetColumns.forEach(colIndex => {
              if(rows[1][colIndex] !== undefined && String(rows[1][colIndex]).trim() !== ''){
                rows[i][colIndex] = String(rows[1][colIndex]).trim();
              }
            });

            currentWidth  += widthInc;
            currentHeight += heightInc;
          }

          const processedCSV = Papa.unparse(rows);
          downloadCSV(processedCSV, 'processed_file.csv');
        }
      });
    }
  </script>
</body>
</html>
